{"componentChunkName":"component---src-templates-post-jsx","path":"/dtrace-flamegraphs-for-freebsd-and-node-js","result":{"data":{"markdownRemark":{"html":"<h6 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h6>\n<p>Recently BSD UNIXes are being acknowledged by the application development community as an interesting operating system to deploy to. </p>\n<p>This is not surprising given that FreeBSD had <a href=\"https://en.wikipedia.org/wiki/FreeBSD_version_history#FreeBSD_4\">jails</a>, the original container system, about 17 years ago and a lot of network focused businesses such as <a href=\"http://www.phoronix.com/scan.php?page=news_item&#x26;px=MTExNDM\">netflix</a> see it as the best way to deliver content. </p>\n<p>This developer interest has led to hosting providers supporting FreeBSD.\ne.g. Amazon, Azure, Joyent and you can get a 2 months free instance at <a href=\"https://m.do.co/c/8a4d6a80663a\">Digital Ocean</a>. </p>\n<p><a href=\"http://dtrace.org/blogs/about/\">DTrace</a> is another vital feature for anyone who has had to deal with production issues and has been in FreeBSD since version 9. As of FreeBSD 11 the operating system now contains <a href=\"https://github.com/indutny/blog/blob/master/posts/7.freebsd-dtrace.md\">some great work by Fedor Indutny</a> so you can profile node applications and create <a href=\"https://nodejs.org/en/blog/uncategorized/profiling-node-js/\">flamegraphs</a> of node.js processes without any additional runtime flags or restarting of processes.\n<img src=\"https://www.cs.brown.edu/~dap/helloworld.svg\">\nTo understand this graphic further the 'father of flamegraphs' Brendan Gregg has provided <a href=\"http://queue.acm.org/detail.cfm?id=2927301\">a great deep dive</a> that also has some entertaining historical context.</p>\n<h6 id=\"instructions\" style=\"position:relative;\"><a href=\"#instructions\" aria-label=\"instructions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instructions</h6>\n<p>In order to configure your FreeBSD instance to utilize this feature make the following changes to the configuration of the server. </p>\n<ol>\n<li>Load DTrace when the OS starts - edit <code class=\"language-text\">/boot/loader.conf</code> or <code class=\"language-text\">/boot/loader.local.conf</code> add the line <code class=\"language-text\">dtraceall_load=&quot;YES&quot;</code> You can also load it without rebooting by running <code class=\"language-text\">kldload dtraceall</code></li>\n<li>Next we need to allow the kernel to load DTrace Object Files greater that 128k - edit <code class=\"language-text\">/etc/sysctl.conf</code> and add\n<code class=\"language-text\">kern.dtrace.helper_actions_max=16000</code> Again you can run this without a reboot with <code class=\"language-text\"># sysctl -w kern.dtrace.helper_actions_max=16000</code></li>\n<li>Install the build tools\n<code class=\"language-text\"># pkg install python gcc git gmake</code></li>\n<li>Now install node.js for FreeBSD from ports to get the latest stable release.\n<code class=\"language-text\"># portsnap fetch</code><br/>\n<code class=\"language-text\"># portsnap extract</code><br/>\n<code class=\"language-text\"># cd /usr/ports/www/node6</code><br/>\n<code class=\"language-text\"># make install clean</code> - Choose the following options\n<img src=\"/content/images/2016/12/node-options.png\"></li>\n<li>npm is also required<br>\n<code class=\"language-text\"># cd /usr/ports/www/npm3</code> <br/>\n<code class=\"language-text\"># make install clean</code><br />\nYou may also want to <a href=\"https://docs.npmjs.com/getting-started/fixing-npm-permissions#option-2-change-npms-default-directory-to-another-directory\">configure npm to install globals to the home directory</a> so you don't have to <code class=\"language-text\">su</code> to often. </li>\n<li>Install <a href=\"https://github.com/joyent/node-stackvis\">stackvis</a> The visualisation tool managed by Dave Pacheco\n<code class=\"language-text\"># npm install -g stackvis</code></li>\n<li>Get the OS source to compile the dtrace libs\n<code class=\"language-text\"># curl http://ftp.freebsd.org/pub/FreeBSD/releases/amd64/11.0-RELEASE/src.txz &gt; src.txz</code></li>\n<li>Then extract them into the default location\n<code class=\"language-text\"># tar -C / -xvf src.txz</code></li>\n<li>We now need to update stackvis. This is a little bit messy while <a href=\"https://github.com/chrisa/node-dtrace-provider/pull/85\">this patch</a> waits to land and stackvis will be updated.\n<code class=\"language-text\"># cd /usr/local/lib/node_modules/stackvis/node_modules</code><br/>\n<code class=\"language-text\"># rm -fr dtrace-provider</code><br/>\n<code class=\"language-text\"># git clone https://github.com/no9/node-dtrace-provider.git</code><br/>\n<code class=\"language-text\"># mv node-dtrace-provider dtrace-provider</code><br/>\n<code class=\"language-text\"># cd dtrace-provider</code><br/>\n<code class=\"language-text\"># git submodule init</code><br/>\n<code class=\"language-text\"># git submodule update</code><br/>\n<code class=\"language-text\"># npm install</code></li>\n</ol>\n<p>You will now be able to follow the <a href=\"https://nodejs.org/en/blog/uncategorized/profiling-node-js/\">flamegraphs</a> tutorial mentioned earlier.</p>\n<h6 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h6>\n<p>I hope you find this article useful. The ability to look at a runtime in this manor has saved me twice this year and I hope it will save you in the future too.\nMy next post on freeBSD and node.js will be looking at some scenarios on utilising the ZFS features.</p>\n<h6 id=\"attribution\" style=\"position:relative;\"><a href=\"#attribution\" aria-label=\"attribution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Attribution</h6>\n<p>The patch to the node-dtrace-provider is only a small part of this story - All the credit goes to <a href=\"https://github.com/indutny\">Fedor Indutny</a>, <a href=\"https://github.com/brendangregg\">Brendon Gregg</a> and <a href=\"https://github.com/davepacheco\">Dave Pacheco</a> for sharing so much information and experience on this topic and making it interesting to get involved in.</p>","timeToRead":3,"excerpt":"Introduction Recently BSD UNIXes are being acknowledged by the application development community as an interesting operating system to…","frontmatter":{"title":"DTrace flamegraphs for FreeBSD and node.js","cover":"images/dtrace-freebsd-cover.png","date":"2016-12-29","category":"tech","tags":["programming","freebsd","nodejs","olly"],"author":"anton"},"fields":{"slug":"/dtrace-flamegraphs-for-freebsd-and-node-js"}},"prev":{"excerpt":"This article is just a quick set of notes that I took while setting up Sinopia on OpenIndiana. It should be…","frontmatter":{"title":"Sinopia on Open Indiana","cover":"https://unsplash.it/1280/500/?random?BoldMage","date":"2016-12-29"},"fields":{"slug":"/sinopia-on-open-indiana"}},"next":{"excerpt":"Update\nIf you are using OI hipster most of these steps won't apply but some of the unmangling and compile…","frontmatter":{"title":"node.js on Open Indiana","cover":"https://unsplash.it/1280/500/?random?BoldMage","date":"2016-12-29"},"fields":{"slug":"/node-js-on-open-indiana"}},"authors":{"edges":[{"node":{"uid":"anton","name":"Anton Whalley","image":"https://avatars2.githubusercontent.com/u/130940?s=460&v=4","url":"http://gatsbyjs.org/","bio":""}}]}},"pageContext":{"slug":"/dtrace-flamegraphs-for-freebsd-and-node-js","total":11,"prev":"/sinopia-on-open-indiana","next":"/node-js-on-open-indiana"}}}