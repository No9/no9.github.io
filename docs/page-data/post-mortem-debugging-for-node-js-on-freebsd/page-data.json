{"componentChunkName":"component---src-templates-post-jsx","path":"/post-mortem-debugging-for-node-js-on-freebsd","result":{"data":{"markdownRemark":{"html":"<h3 id=\"motivation\" style=\"position:relative;\"><a href=\"#motivation\" aria-label=\"motivation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Motivation</h3>\n<p>A few months ago I was talking to <a href=\"https://twitter.com/nomadlogicLA\">nomadlogicLA</a> on twitter about managing node.js processes on FreeBSD.</p>\n<p>The obstacle that nomadlogic was trying to get around was how to handle a node.js process that kept stopping due to memory issues.\n<img src=\"/content/images/2017/08/Motivation.png\"></p>\n<p>The problem was overcome by restarting the process. </p>\n<p>While this got over the immediate issue there was obviously and underlying problem and from experience I know these things will come back to bite you on a cold dark evening.</p>\n<p>Now I'm probably overly invested in this simple twitter exchange but I started to get concerned. </p>\n<p><strong>What would happen to nomad's system under heavy load?</strong></p>\n<p><strong>What if it was an edge case that could become more prevalent if the users started using the app in a slightly different way?</strong></p>\n<p>So I tried to prompt nomad to doing some root cause of the memory issue by using the <a href=\"https://strongloop.com/strongblog/how-to-heap-snapshots/\">heapdump tools</a> from strongloop.</p>\n<blockquote>\n<p>Unsurprisingly the discussion went cold.</p>\n</blockquote>\n<p>The heapdump approach has some nits. It needs an additional component and code changes in the application. This is typical as library based approaches are invasive and updating at the application level can require cross team coordination that is sometimes difficult due to organizational boundaries. </p>\n<p>In the past I have navigated around these type of constraints by running the node.js process with the <code class=\"language-text\">--abort-on-uncaught-exception</code> flag and <a href=\"https://www.joyent.com/blog/mdb-and-node-js\">analyzing the output</a> on <a href=\"https://www.openindiana.org/\">open indiana</a> with mdb.</p>\n<p>This works if you are running the node application on a Linux or illumOS system but mdb doesn't currently support FreeBSD cores although <a href=\"https://github.com/ahrens/illumos/commit/018e181a674cb836d62b1dcee9833c15068d7444\">some work has been started on it</a> by Matt Ahrens.</p>\n<p>I had heard that <a href=\"https://vimeo.com/172629474\">Fedor Indutny</a> had put some work into getting core dumps of node.js working with lldb so I went to find how servicable that would be for FreeBSD.</p>\n<p>It turned out that after a couple of tweaks to the build process and a <a href=\"https://github.com/nodejs/llnode/pull/96/commits\">few patches submitted</a> to llnode - post mortem debugging of node.js processes on FreeBSD is now very easy to do. </p>\n<blockquote>\n<p>post mortem debugging of node.js processes on FreeBSD is very easy</p>\n</blockquote>\n<p>The rest of this article will provide a step by step guide for setting up a clean FreeBSD and running a sample scenario to show what is achievable.</p>\n<h3 id=\"setup\" style=\"position:relative;\"><a href=\"#setup\" aria-label=\"setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setup</h3>\n<p>This was tested on a FreeBSD 11.1 on <a href=\"https://cloud.digitalocean.com/droplets/new?i=eedd1f&#x26;size=2gb&#x26;region=nyc3&#x26;distro=freebsd&#x26;distroImage=freebsd-11-1-x64-zfs\">Digital Ocean</a> so we will step through all the steps for configuring a vanilla image.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># sudo pkg install node npm llvm39</code></pre></div>\n<h3 id=\"configure-lldb\" style=\"position:relative;\"><a href=\"#configure-lldb\" aria-label=\"configure lldb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configure lldb</h3>\n<p>We are going to use 3.9 as other versions of lldb <a href=\"https://github.com/nodejs/llnode/issues/93\">seem to have an issues</a> with some of the commands</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># sudo rm -f /usr/bin/lldb\n# sudo ln -s /usr/local/llvm39/bin/lldb /usr/bin/lldb</code></pre></div>\n<h3 id=\"install-llnode\" style=\"position:relative;\"><a href=\"#install-llnode\" aria-label=\"install llnode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install llnode</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># sudo npm install llnode -g --unsafe-perm</code></pre></div>\n<p>This will give us an <code class=\"language-text\">llnode</code> command that we can load from the commandline prompt and you should be dropped into an lldb session with the <code class=\"language-text\">v8</code> plugin preloaded.</p>\n<h3 id=\"verify-the-install\" style=\"position:relative;\"><a href=\"#verify-the-install\" aria-label=\"verify the install permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verify the install</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">% llnode \n(llnode)\n(llnode) v8\nv8\n     Node.js helpers\n     ...\n(llnode) exit</code></pre></div>\n<h3 id=\"example-usage\" style=\"position:relative;\"><a href=\"#example-usage\" aria-label=\"example usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example Usage</h3>\n<p>Now we have a working environment I am going to give a sample demo using the introduction from this <a href=\"https://developer.ibm.com/node/2016/08/15/exploring-node-js-core-dumps-using-the-llnode-plugin-for-lldb/\">great tutorial by Howard Hellyer</a> It's simple helloworld but I've updated to use llnode command prompt rather than the underlying lldb as mentioned in that article.</p>\n<p><strong>1. Create a broken server that calls itself</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">var http = require(&#39;http&#39;);\nvar host = &#39;127.0.0.1&#39;;\nvar port = 1338;\n\nserver = http.createServer(function myRequestListener(req, res) {\n     res.writeHead(200, {&#39;Content-Type&#39;: &#39;text/plain&#39;});\n     res.end(&#39;Hello World\\n&#39;);\n     res.not_a_function();\n}).listen(port, host, function() {\n     http.get(`http://${host}:${port}/`, function(res){});\n});\nconsole.log(`Server process ${process.pid} running at http://${host}:${port}/`);</code></pre></div>\n<p><strong>2. Run the server</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">% node --abort-on-uncaught-exception httpexception.js</code></pre></div>\n<p>This should fail instantly and a core dump called node.core created in the same folder.</p>\n<p><strong>3. Load the core file into llnode</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">% llnode node -c node.core </code></pre></div>\n<p>where node is the executable to load along side the core dump</p>\n<p><strong>4. Print the objects in memory at the time of the crash</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">(llnode) v8 findjsobjects\nInstances  Total Size Name\n ---------- ---------- ----\n          1         24 Control\n          1         24 FastBuffer\n          1         24 JSON\n          1         24 Math\n          1         24 RangeError\n          1         24 TypeError\n          1         32 Arguments\n          1         32 TCPConnectWrap</code></pre></div>\n<h3 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h3>\n<p>You should now be able to see how easy it is to load a core dump of a dying process and to understand what is causing it to fail. </p>\n<p>You might want to go back over <a href=\"https://developer.ibm.com/node/2016/08/15/exploring-node-js-core-dumps-using-the-llnode-plugin-for-lldb/\">Howard's article</a> to get more info on traversing the back traces.</p>\n<p>If you having memory type issues like the one mentioned at the start of the article then Brendon Gregg has <a href=\"http://www.brendangregg.com/blog/2016-07-13/llnode-nodejs-memory-leak-analysis.html\">a great article</a> on how to use llnode to dive into resolving those issues.</p>\n<p>Until next time ... happy debugging</p>","timeToRead":5,"excerpt":"Motivation A few months ago I was talking to nomadlogicLA on twitter about managing node.js processes on FreeBSD. The obstacle that…","frontmatter":{"title":"Post Mortem debugging for node.js on FreeBSD","cover":"./images/post-mortem-freebsd.png","date":"2017-08-15","category":"tech","tags":["programming","olly","nodejs","freebsd"],"author":"anton"},"fields":{"slug":"/post-mortem-debugging-for-node-js-on-freebsd"}},"prev":{"excerpt":"The following is a set of notes for installing VSCode on FreeBSD and getting a debugger up and running in a step…","frontmatter":{"title":"Debugging Rust with VSCode on FreeBSD","cover":"images/debug-rust.png","date":"2018-12-28"},"fields":{"slug":"/debugging-rust-with-vscode-on-freebsd"}},"next":{"excerpt":"Most of my days are spent up to my knees thinking about APIs. But this week I was asked to build a person finder…","frontmatter":{"title":"Some notes on vue.js with browserify on bluemix","cover":"images/browserify-vue.png","date":"2017-04-19"},"fields":{"slug":"/vue-js-with-browserify-on-bluemix"}},"authors":{"edges":[{"node":{"uid":"anton","name":"Anton Whalley","image":"https://avatars2.githubusercontent.com/u/130940?s=460&v=4","url":"http://gatsbyjs.org/","bio":""}}]}},"pageContext":{"slug":"/post-mortem-debugging-for-node-js-on-freebsd","total":11,"prev":"/debugging-rust-with-vscode-on-freebsd","next":"/vue-js-with-browserify-on-bluemix"}}}